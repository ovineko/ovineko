# spa-guard: Version Extraction, Templates, Spinner & i18n

## Overview

Four improvements to @ovineko/spa-guard in one plan:

1. Robust version extraction via separate `__SPA_GUARD_VERSION__` variable (TODO-1)
2. Improved default HTML templates with styling, SVG icon, and data attributes (TODO-2/1)
3. Spinner overlay: Vite body injection, runtime API, React component (TODO-2/3)
4. i18n support: meta tag approach, server-side patching, built-in translations (TODO-2/2)

## Context

- Files involved: see individual tasks below
- Related patterns: data attributes for DOM manipulation (`data-spa-guard-content`, `data-spa-guard-action`), tsup multi-config build (inline + main dist)
- Dependencies: html-minifier-terser (already present), no new external deps

**Key architectural finding:** The inline script (`reload.ts`) and `DefaultErrorFallback.tsx` are two separate code paths for rendering fallback/loading UI. Currently the inline script ONLY shows the error fallback; it does NOT show loading UI during retry delays (user sees stale content while waiting for reload). This plan adds inline loading UI during retry delays.

**Improvement over TODO:** Version detection will try `__SPA_GUARD_VERSION__` first, then fall back to the old `__SPA_GUARD_OPTIONS__` regex. This handles the case when a new spa-guard client fetches HTML generated by an older spa-guard version (gradual rollout, rolling deployment).

**Improvement over TODO:** `DefaultErrorFallback.tsx` currently uses fragile `.replace()` string manipulation on minified HTML. This plan refactors it to the virtual container + data attribute approach, making it robust against template changes.

## Development Approach

- **Testing approach**: Regular (code first, then tests)
- Complete each task fully before moving to the next
- Inline script changes require rebuilding `dist-inline/` via build command
- **CRITICAL: every task MUST include new/updated tests**
- **CRITICAL: all tests must pass before starting next task**

## Implementation Steps

### Task 1: Robust version extraction

**Files:**

- Modify: `packages/spa-guard/src/vite-plugin/index.ts`
- Modify: `packages/spa-guard/src/common/checkVersion.ts`

- [x] In `getInlineScript`, prepend `window.__SPA_GUARD_VERSION__="${processedOptions.version}";` before the existing `window.__SPA_GUARD_OPTIONS__=...` assignment
- [x] Check if `{version, ...other} = processedOptions` destructuring exists in vite plugin; remove if present (no longer needed)
- [x] Verify that `dist-inline/index.js` is minified single-line JS (check tsup.inline.config.ts terser settings)
- [x] In `fetchHtmlVersion` (`checkVersion.ts`): collapse newlines with `html.replace(/[\r\n]+/g, "")`, then try `/__SPA_GUARD_VERSION__\s*=\s*"([^"]+)"/` first; if no match, fall back to existing `__SPA_GUARD_OPTIONS__` regex for backwards compatibility
- [x] Write tests: `getInlineScript` output contains `__SPA_GUARD_VERSION__="..."` prefix; `fetchHtmlVersion` extracts from new format; extracts from old format (no `__SPA_GUARD_VERSION__`); works with newlines from formatters; works with unquoted keys (JSDOM behavior)
- [x] Run project test suite — must pass before task 2

### Task 2: Upgrade default HTML templates and refactor DefaultErrorFallback

**Files:**

- Modify: `packages/spa-guard/src/fallback-error.html`
- Modify: `packages/spa-guard/src/fallback-loading.html`
- Modify: `packages/spa-guard/scripts/generate-fallback.ts` (if needed)
- Modify: `packages/spa-guard/src/common/DefaultErrorFallback.tsx`

- [x] Replace `fallback-error.html` with the styled version from `TODO/TODO-2/error-fallback.html` (SVG icon, system-ui + ui-monospace fonts, styled buttons, `:has()` CSS for error ID hiding)
- [x] Replace `fallback-loading.html` with new version from `TODO/TODO-2/loading-state.html` (`[data-spa-guard-spinner]` with default SVG spinner + `@keyframes`, `data-spa-guard-content="loading"`, retrying section with data attributes)
- [x] Run `generate-fallback.ts` to regenerate `fallbackHtml.generated.ts`
- [x] Refactor `DefaultErrorFallback.tsx`: replace brittle `.replace()` string manipulation with virtual container approach — create a div, set innerHTML, query by data attributes (`[data-spa-guard-content]`, `[data-spa-guard-action]`, `[data-spa-guard-section]`) to manipulate content and visibility, then assign to ref. This makes the component template-agnostic
- [x] Update existing tests that assert on specific HTML structure (e.g., test checking no `@keyframes` in loading template)
- [x] Write tests: templates contain expected data attributes; DefaultErrorFallback renders correctly with new templates; retry section visibility toggling works via data attributes
- [x] Run project test suite — must pass before task 3

### Task 3: Spinner overlay

**Files:**

- Modify: `packages/spa-guard/src/common/options.ts`
- Create: `packages/spa-guard/src/common/spinner.ts`
- Modify: `packages/spa-guard/src/vite-plugin/index.ts`
- Modify: `packages/spa-guard/src/common/reload.ts`
- Modify: `packages/spa-guard/src/runtime/index.ts`
- Modify: `packages/spa-guard/src/runtime/recommendedSetup.ts`
- Create: `packages/spa-guard/src/react/Spinner.tsx`
- Modify: `packages/spa-guard/src/react/index.tsx`
- Modify: `packages/spa-guard/src/common/DefaultErrorFallback.tsx`

- [x] Add `spinner?: { content?: string; disabled?: boolean; background?: string }` to `Options` interface; add defaults to `defaultOptions`
- [x] Create `spinner.ts`: `SPINNER_ID` constant, `defaultSpinnerSvg` (SVG circle animation), `getSpinnerHtml(backgroundOverride?)`, `showSpinner(options?)` returning cleanup fn, `dismissSpinner()`
- [x] `showSpinner`: remove existing spinner if any, create overlay with `position:fixed;inset:0;z-index:2147483647` and CSS variable `background: var(--spa-guard-spinner-bg, <bg>)`, set `body.style.overflow="hidden"`, return `dismissSpinner`
- [x] `dismissSpinner`: remove element by ID, restore `body.style.overflow`
- [x] Vite plugin `transformIndexHtml`: if `spinner.disabled !== true`, push `HtmlTagDescriptor`s for spinner div (`body-prepend`), `body.style.overflow='hidden'` script (`body-prepend`), and if bg differs from `#fff` — `:root` CSS variable style (`head`)
- [x] In `recommendedSetup`, call `dismissSpinner()` at the start
- [x] Export `showSpinner`, `dismissSpinner`, `getSpinnerHtml` from `runtime/index.ts`
- [x] Create React `Spinner` component: reads options, returns null if disabled, otherwise renders div with `dangerouslySetInnerHTML`. Export from `react/index.tsx`
- [x] In `DefaultErrorFallback.tsx`: when building loading virtual container, inject spinner content from options into `[data-spa-guard-spinner]`
- [x] In `reload.ts`: add `showLoadingUI()` that renders loading template to fallback selector during retry delays — inject spinner content into `[data-spa-guard-spinner]`, show retry section, set attempt number; call before scheduling page reload in `attemptReload`
- [x] Write tests: `showSpinner`/`dismissSpinner` lifecycle; `spinner.disabled` makes everything no-op; `getSpinnerHtml` with custom background; Vite plugin body injection; React Spinner component; loading template spinner injection; `showLoadingUI` renders during retry delays
- [x] Run project test suite — must pass before task 4

### Task 4: i18n support

**Files:**

- Create: `packages/spa-guard/src/i18n/index.ts`
- Create: `packages/spa-guard/src/server/index.ts`
- Modify: `packages/spa-guard/src/common/reload.ts`
- Modify: `packages/spa-guard/src/common/DefaultErrorFallback.tsx`
- Modify: `packages/spa-guard/package.json`
- Modify: `packages/spa-guard/tsup.config.ts`

- [x] Create `SpaGuardTranslations` interface: `heading`, `message`, `reload`, `tryAgain`, `loading`, `retrying`, `rtl?`
- [x] Create `translations` Record with built-ins: en, ko, ja, zh, ar (rtl), he (rtl) — using strings from TODO-2
- [x] Implement `matchLang(input, available)`: detect Accept-Language header vs simple code; parse q-values; exact then prefix matching; fallback `"en"`
- [x] Implement `escapeAttr(str)`: escape `&`, `"`, `<`, `>` for HTML attribute safety
- [x] Implement `patchHtmlI18n({ html, acceptLanguage?, lang?, translations? })`: merge custom translations with built-in (per-language deep merge), resolve language via `matchLang`, English without custom translations is no-op, inject `<meta name="spa-guard-i18n" content="...">` into `<head>`, update `<html lang="...">`
- [x] Add `getI18n()` helper (shared by inline + React): read `<meta name="spa-guard-i18n">`, return parsed JSON or null
- [x] In `reload.ts` `showFallbackUI` and `showLoadingUI`: after building virtual container, call `getI18n()`, iterate `[data-spa-guard-content]` and `[data-spa-guard-action]` patching textContent, handle `rtl` flag
- [x] In `DefaultErrorFallback.tsx`: add i18n patching pass in virtual container using same `getI18n()` + data attribute logic
- [x] Add `./i18n` and `./server` exports to `package.json` (types + import, matching existing pattern)
- [x] Add `src/i18n/index.ts` and `src/server/index.ts` to tsup.config.ts entry points
- [x] Re-export `translations`, `matchLang`, `SpaGuardTranslations` from `server/index.ts`
- [x] Write tests: `matchLang` — direct code, prefix match, Accept-Language parsing, undefined; `patchHtmlI18n` — English no-op, Korean meta tag injection, custom partial override, RTL; `escapeAttr` — special chars; `getI18n` — present/absent/malformed; inline i18n patching for both fallback and loading HTML
- [x] Rebuild dist-inline and verify end-to-end
- [x] Run project test suite — must pass before task 5

### Task 5: Verify acceptance criteria

- [ ] Run full test suite: `pnpm --filter @ovineko/spa-guard test`
- [ ] Run linter: `pnpm --filter @ovineko/spa-guard lint`
- [ ] Run build: `pnpm --filter @ovineko/spa-guard build` — verify no errors
- [ ] Verify test coverage meets 80%+
- [ ] Verify dist-inline bundle size increase is reasonable (i18n + spinner additions under ~500 bytes minified)
- [ ] Verify new entry points resolve correctly (`@ovineko/spa-guard/i18n`, `@ovineko/spa-guard/server`)

### Task 6: Update documentation

- [ ] Update README.md: spinner option docs, i18n usage examples (patchHtmlI18n, matchLang, runtime language update), data attribute contract for custom HTML, new entry points
- [ ] Update CLAUDE.md if internal patterns changed
- [ ] Move this plan to `docs/plans/completed/`
