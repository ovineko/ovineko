---

**Задача: надёжное извлечение версии из HTML для механизма version detection**

**Контекст и корневая проблема:**

Библиотека `@ovineko/spa-guard` инлайнит скрипт в `<head>` через vite-плагин. Скрипт содержит `window.__SPA_GUARD_OPTIONS__` — объект с настройками, в том числе с полем `version`. Механизм version detection раз в N минут делает `fetch` HTML страницы и пытается извлечь версию регуляркой из этого объекта.

Проблема в том, что библиотека не контролирует что происходит с HTML **после** того как она его сгенерировала. Пользователь библиотеки может дополнительно обрабатывать HTML любым инструментом — JSDOM, cheerio, html-minifier, собственный препроцессор, серверный шаблонизатор и т.д. Любой из этих инструментов при парсинге и повторной сериализации HTML может изменить содержимое тега `<script>`:

- JSDOM при чтении `.innerHTML` и записи обратно превращает валидный JSON `{"version":"...","errors":{...}}` в JS-объектный литерал `{version:"...",errors:{...}}` — убирает кавычки с ключей
- html-minifier может переставить местами ключи объекта
- форматтер может добавить пробелы вокруг `=` и переносы строк внутри скрипта
- любой другой инструмент может сделать что угодно с содержимым скрипта

В результате любая регулярка которая пытается разобрать `window.__SPA_GUARD_OPTIONS__` как структуру — хрупкая по определению, потому что зависит от конкретного формата сериализации объекта, который может измениться по причинам вне контроля библиотеки.

**Решение:**

Два защитных слоя:

**Слой 1 — на стороне генерации скрипта в библиотеке.** Добавить отдельную переменную `window.__SPA_GUARD_VERSION__` которая содержит только строку с версией. Строковое значение в JS — атомарная единица, которую ни один инструмент не переформатирует, потому что он не знает что эта строка значит и у него нет причин её менять. В отличие от объекта, строку нельзя "переформатировать".

**Слой 2 — на стороне version detection при чтении HTML.** Перед запуском регулярки схлопывать все переносы строк в одну строку. Это защищает от случая когда форматтер пользователя разбил скрипт на несколько строк.

**Что нужно изменить:**

**1. Функция `getInlineScript` в vite-плагине**

Добавить переменную `window.__SPA_GUARD_VERSION__` перед основным скриптом:

```ts
return `window.__SPA_GUARD_VERSION__="${processedOptions.version}";window.${optionsWindowKey}=${JSON.stringify(processedOptions).replaceAll("<", "\\u003c")};${script}`;
```

В итоговом HTML это будет выглядеть так:
```html
<script>window.__SPA_GUARD_VERSION__="97b4c6c0-c707-46f5-a310-c36af5c2ee68";window.__SPA_GUARD_OPTIONS__={...};...</script>
```

Также **перепроверить** что `script` (содержимое `index.js` которое читается через `readFile`) является минифицированным однострочным JS. Если нет — добавить минификацию JS при сборке `dist-inline/index.js`, чтобы гарантировать что весь инлайн-скрипт это одна строка без переносов.

**2. Механизм version detection в core-части библиотеки**

Заменить текущую логику извлечения версии на:

```js
const singleLine = html.split(/\r?\n|\r/).join('');
const version = singleLine.match(/__SPA_GUARD_VERSION__\s*=\s*"([^"]+)"/)?.[1] ?? null;
```

Почему это надёжно:
- `split(/\r?\n|\r/).join('')` убирает все переносы строк (`\n`, `\r\n`, `\r`) перед поиском — защита от форматтеров которые могли разбить скрипт на строки
- `\s*=\s*` покрывает любые варианты пробелов вокруг `=` — с пробелами, без пробелов, с несколькими пробелами
- регулярка не зависит от структуры объекта, порядка ключей, наличия или отсутствия кавычек у ключей
- строковое значение `"([^"]+)"` — форматтер никогда не полезет внутрь строкового литерала

**Что не трогаем:**
- Структура и содержимое `window.__SPA_GUARD_OPTIONS__` остаётся без изменений
- Вся остальная логика version detection — интервал опроса, сравнение версий, механизм reload — остаётся без изменений
- Деструктуризацию `const {version, ...other} = processedOptions` которая была добавлена ранее с целью поставить `version` первым ключом — убрать, она больше не нужна

---
